"use strict";var FraglateClass=function(){function e(e){var i=e.split("-",2),l=i[0],t=i[1];return t=s.isNil(t)?null:t.toLowerCase(),[l,t]}function i(e,i,l){return s.isNil(l)&&!s.isNil(e[i])?!0:!(s.isNil(l)||s.isNil(e[i])||s.isNil(e[i].region[l]))}function l(e,i){return i?e+"-"+i:e}function t(e,i){this.config=Object.assign({},t.DEFAULT_CONFIG,e),this.locales={},s.isNil(i)?this.load_all_localesSync(this.config.locale_path):this.load_all_locales(this.config.locale_path,i),global[this.config.translate]=this._t.bind(this),global[this.config.eval]=this._e.bind(this)}var o=require("./FraglateEval"),s=require("./util"),a=require("asyncawait/async"),n=require("asyncawait/await"),r=require("bluebird"),c=r.promisifyAll(require("fs")),u=require("path"),f=require("process");return t.EVAL=o,t.DEFAULT_CONFIG={translate:"_t",eval:"_e",locale_path:u.join(f.cwd(),"locale"),locale_extension:"json",default_locale:"en",cookiename:"locale"},t.GET_ACCEPTED_LANGUAGES_FROM_HEADER=function(e){var i=e.split(",");return i.map(function(e){var i=e.trim().split(";q=");if(i.length<2)i.push(1);else{var l=parseFloat(i[1]);i[1]=l?l:0}return i}).filter(function(e){return e[1]>0}).sort(function(e,i){return i[1]-e[1]})},t.prototype.as_middleware=function(){return function(e,i,l){return e.locale||this.guess_language(e),this.express_request=e,"function"==typeof l?l():void 0}.bind(this)},t.prototype.process_locale_content=function(i,l){var t=e(i.replace(/\.json$/g,"")),o=t[0],a=t[1],n=JSON.parse(l);s.isNil(a)?s.isNil(this.locales[o])?this.locales[o]={data:n,region:{}}:this.locales[o].data=n:s.isNil(this.locales[o])?(this.locales[o]={data:"",region:{}},this.locales[o].region[a]=n):this.locales[o].region[a]=n},t.prototype.load_all_locales=function(e,i){var l=a(function(e,i){var l=n(c.readdirAsync(e)),t=n(l.map(function(i){return c.readFileAsync(u.join(e,i)).then(function(e){return[i,e]})}));t.map(function(e){var i=e[0],l=e[1];this.process_locale_content(i,l)}.bind(this))}.bind(this));l(e).then(i)["catch"](i)},t.prototype.load_all_localesSync=function(e){var i=c.readdirSync(e);i.map(function(i){var l=c.readFileSync(u.join(e,i));this.process_locale_content(i,l)}.bind(this))},t.prototype.guess_language=function(o){if("object"==typeof o){var a=this.config.cookiename;if(!s.isNil(a)&&!s.isNil(o.cookies)&&!s.isNil(o.cookies[a])){var n=o.cookies[a],r=e(n);if(i(this.locales,r[0],r[1]))return void(o.locale=l(r[0],r[1]))}var c=o.headers["accept-language"];if(c){for(var u=t.GET_ACCEPTED_LANGUAGES_FROM_HEADER(c),f=null,h=null,p=e(this.config.default_locale),_=0;_<u.length;++_){var r=e(u[_][0]),g=r[0],d=r[1],N=this.locales[g],v=this.locales[g].region[d];if(s.isNil(d)&&!s.isNil(N)){f=[g,null];break}if(!(s.isNil(d)||s.isNil(N)||s.isNil(v))){f=[g,d];break}s.isNil(d)||s.isNil(N)||!s.isNil(v)||(h=[g,null])}var y=f||h||p;o.locale=l(y[0],y[1])}}},t.prototype._t=function(l,t,o){s.isNil(t)&&(t=s.isNil(this.express_request)?this.config.default_locale:this.express_request.locale);var a=e(t),n=a[0],r=a[1];return i(this.locales,n,r)?this.translate(l,n,r,o):(console.error("Locale '"+t+"' is not configured!"),console.error("Locale available: "+JSON.stringify(this.locales)),"")},t.prototype._e=function(l,o,a){s.isNil(o)&&(o=s.isNil(this.express_request)?this.config.default_locale:this.express_request.locale);var n=e(o),r=n[0],c=n[1];return i(this.locales,r,c)?new t.EVAL(this).eval(l,r,c,a):(console.error("Locale '"+o+"' is not configured!"),"")},t.prototype.translate=function(e,i,l,o){var a=new t.EVAL(this),n=s.isNull(l)?this.locales[i].data[e]:this.locales[i].region[l][e];return"string"==typeof n?a.eval(n,i,l,o):("undefined"==typeof n?console.error("locale: "+locale.toString()+', no translation to key: "'+e.toString()+'"'):console.error("locale: "+locale.toString()+", translation to '"+(typeof n).toString()+"' is not supported!"),null)},t}();module.exports=FraglateClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkZyYWdsYXRlQ2xhc3MiLCJfX2dldF9sYW5nX3JlZ2lvbiIsImxhbmdfc3RyIiwibGFuZ19yZWdpb24iLCJzcGxpdCIsImxhbmciLCJyZWdpb24iLCJfIiwiaXNOaWwiLCJ0b0xvd2VyQ2FzZSIsIl9faXNfZXhpc3RfbG9jYWxlIiwibG9jYWxlcyIsIl9fY29uc3RydWN0X2xhbmdfcmVnaW9uIiwiRnJhZ2xhdGUiLCJjb25maWciLCJjYWxsYmFjayIsInRoaXMiLCJPYmplY3QiLCJhc3NpZ24iLCJERUZBVUxUX0NPTkZJRyIsImxvYWRfYWxsX2xvY2FsZXNTeW5jIiwibG9hZF9hbGxfbG9jYWxlcyIsImdsb2JhbCIsIl90IiwiYmluZCIsIl9lIiwiRnJhZ2xhdGVFdmFsIiwicmVxdWlyZSIsIl9fYXN5bmNfXyIsIl9fYXdhaXRfXyIsImJsdWViaXJkIiwiZnMiLCJwcm9taXNpZnlBbGwiLCJwYXRoIiwicHJvY2VzcyIsIkVWQUwiLCJ0cmFuc2xhdGUiLCJldmFsIiwibG9jYWxlX3BhdGgiLCJqb2luIiwiY3dkIiwibG9jYWxlX2V4dGVuc2lvbiIsImRlZmF1bHRfbG9jYWxlIiwiY29va2llbmFtZSIsIkdFVF9BQ0NFUFRFRF9MQU5HVUFHRVNfRlJPTV9IRUFERVIiLCJoZWFkZXIiLCJsYW5ndWFnZXMiLCJtYXAiLCJpdGVtIiwicHJlZmVyZW5jZSIsInRyaW0iLCJsZW5ndGgiLCJwdXNoIiwicXVhbGl0eSIsInBhcnNlRmxvYXQiLCJmaWx0ZXIiLCJzb3J0IiwicHJlZmVyZW5jZTEiLCJwcmVmZXJlbmNlMiIsInByb3RvdHlwZSIsImFzX21pZGRsZXdhcmUiLCJyZXEiLCJyZXMiLCJuZXh0IiwibG9jYWxlIiwiZ3Vlc3NfbGFuZ3VhZ2UiLCJleHByZXNzX3JlcXVlc3QiLCJwcm9jZXNzX2xvY2FsZV9jb250ZW50IiwiZmlsZW5hbWUiLCJmaWxlY29udGVudCIsInJlcGxhY2UiLCJjb250ZW50IiwiSlNPTiIsInBhcnNlIiwiZGF0YSIsImxvYWRfYWxsX2xvY2FsZXNfYXN5bmMiLCJmaWxlcyIsInJlYWRkaXJBc3luYyIsImZpbGVfY29udGVudF9wYWlycyIsInJlYWRGaWxlQXN5bmMiLCJ0aGVuIiwiZmlsZV9jb250ZW50IiwicmVhZGRpclN5bmMiLCJyZWFkRmlsZVN5bmMiLCJjb29raWVzIiwiY29va2llX2xvY2FsZSIsImFjY19sYW5ncyIsImhlYWRlcnMiLCJwcmVmX2xhbmdzIiwiYmVzdEd1ZXNzIiwiZmFsbGJhY2tHdWVzcyIsImRlZmF1bHRMb2NhbGUiLCJpIiwibG9jYWxlc19sYW5nIiwibG9jYWxlc19yZWdpb24iLCJmaW5hbEd1ZXNzIiwia2V5IiwibG9jYWxlX3N0ciIsImNvbnRleHQiLCJjb25zb2xlIiwiZXJyb3IiLCJzdHJpbmdpZnkiLCJzdHIiLCJmZSIsImxvY2FsZXVuaXQiLCJpc051bGwiLCJ0b1N0cmluZyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLFlBRUEsSUFBSUEsZUFBZ0IsV0FXaEIsUUFBU0MsR0FBa0JDLEdBQ3ZCLEdBQUlDLEdBQWNELEVBQVNFLE1BQU0sSUFBSyxHQUNsQ0MsRUFBT0YsRUFBWSxHQUNuQkcsRUFBU0gsRUFBWSxFQU16QixPQUZJRyxHQUhDQyxFQUFFQyxNQUFNRixHQUdBLEtBRkFBLEVBQU9HLGVBSVpKLEVBQU1DLEdBR2xCLFFBQVNJLEdBQWtCQyxFQUFTTixFQUFNQyxHQUN0QyxNQUFJQyxHQUFFQyxNQUFNRixLQUFZQyxFQUFFQyxNQUFNRyxFQUFRTixLQUM3QixJQUNDRSxFQUFFQyxNQUFNRixJQUFZQyxFQUFFQyxNQUFNRyxFQUFRTixLQUFXRSxFQUFFQyxNQUFNRyxFQUFRTixHQUFjLE9BQUVDLEtBTS9GLFFBQVNNLEdBQXdCUCxFQUFNQyxHQUNuQyxNQUFJQSxHQUNPRCxFQUFPLElBQU1DLEVBRWpCRCxFQUdYLFFBQVNRLEdBQVNDLEVBQVFDLEdBQ3RCQyxLQUFLRixPQUFTRyxPQUFPQyxVQUFXTCxFQUFTTSxlQUFnQkwsR0FvQnpE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c0IsS0FBS25CLE1BQU1xQixLQUFLaUUsRUFBS2pHLEVBQU1DLEVBQVE0RixJQUhuREMsUUFBUUMsTUFBTSxXQUFhSCxFQUFhLHdCQUNqQyxLQUtmcEYsRUFBUzhDLFVBQVV2QixVQUFZLFNBQVM0RCxFQUFLM0YsRUFBTUMsRUFBUTRGLEdBQ3ZELEdBQUlLLEdBQUssR0FBSTFGLEdBQVNzQixLQUFLbkIsTUFDdkJ3RixFQUFnQmpHLEVBQUVrRyxPQUFPbkcsR0FDUFUsS0FBS0wsUUFBUU4sR0FBWSxLQUFFMkYsR0FDM0JoRixLQUFLTCxRQUFRTixHQUFjLE9BQUVDLEdBQVEwRixFQUMzRCxPQUEwQixnQkFBZlEsR0FDQUQsRUFBR2xFLEtBQUttRSxFQUFZbkcsRUFBTUMsRUFBUTRGLElBQ1osbUJBQWZNLEdBQ2RMLFFBQVFDLE1BQU0sV0FBYXBDLE9BQU8wQyxXQUNsQiw2QkFDQVYsRUFBSVUsV0FBYSxLQUVqQ1AsUUFBUUMsTUFBTSxXQUFhcEMsT0FBTzBDLFdBQ2xCLDRCQUNRRixJQUFZRSxXQUNwQix1QkFFYixPQUdKN0YsSUFHWDhGLFFBQU9DLFFBQVU1RyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIEZyYWdsYXRlQ2xhc3MgPSAoZnVuY3Rpb24oKSB7XG4gICAgdmFyIEZyYWdsYXRlRXZhbCA9IHJlcXVpcmUoJy4vRnJhZ2xhdGVFdmFsJyk7XG4gICAgdmFyIF8gPSByZXF1aXJlKCcuL3V0aWwnKTtcblxuICAgIHZhciBfX2FzeW5jX18gPSByZXF1aXJlKCdhc3luY2F3YWl0L2FzeW5jJyk7XG4gICAgdmFyIF9fYXdhaXRfXyA9IHJlcXVpcmUoJ2FzeW5jYXdhaXQvYXdhaXQnKTtcbiAgICB2YXIgYmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuICAgIHZhciBmcyA9IGJsdWViaXJkLnByb21pc2lmeUFsbChyZXF1aXJlKCdmcycpKTtcbiAgICB2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgICB2YXIgcHJvY2VzcyA9IHJlcXVpcmUoJ3Byb2Nlc3MnKTtcblxuICAgIGZ1bmN0aW9uIF9fZ2V0X2xhbmdfcmVnaW9uKGxhbmdfc3RyKSB7XG4gICAgICAgIHZhciBsYW5nX3JlZ2lvbiA9IGxhbmdfc3RyLnNwbGl0KCctJywgMik7XG4gICAgICAgIHZhciBsYW5nID0gbGFuZ19yZWdpb25bMF07XG4gICAgICAgIHZhciByZWdpb24gPSBsYW5nX3JlZ2lvblsxXTtcbiAgICAgICAgaWYgKCFfLmlzTmlsKHJlZ2lvbikpIHtcbiAgICAgICAgICAgIHJlZ2lvbiA9IHJlZ2lvbi50b0xvd2VyQ2FzZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVnaW9uID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW2xhbmcsIHJlZ2lvbl07XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX19pc19leGlzdF9sb2NhbGUobG9jYWxlcywgbGFuZywgcmVnaW9uKSB7XG4gICAgICAgIGlmIChfLmlzTmlsKHJlZ2lvbikgJiYgIV8uaXNOaWwobG9jYWxlc1tsYW5nXSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGVsc2UgaWYgKCFfLmlzTmlsKHJlZ2lvbikgJiYgIV8uaXNOaWwobG9jYWxlc1tsYW5nXSkgJiYgIV8uaXNOaWwobG9jYWxlc1tsYW5nXVsncmVnaW9uJ11bcmVnaW9uXSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBfX2NvbnN0cnVjdF9sYW5nX3JlZ2lvbihsYW5nLCByZWdpb24pIHtcbiAgICAgICAgaWYgKHJlZ2lvbikge1xuICAgICAgICAgICAgcmV0dXJuIGxhbmcgKyAnLScgKyByZWdpb247XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxhbmc7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gRnJhZ2xhdGUoY29uZmlnLCBjYWxsYmFjaykge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIEZyYWdsYXRlLkRFRkFVTFRfQ09ORklHLCBjb25maWcpO1xuICAgICAgICAvKlxuICAgICAgICAgIExvY2FsZSBEYXRhIFN0cnVjdHVyZTpcbiAgICAgICAgICB7XG4gICAgICAgICAgICAnZW4nOiB7XG4gICAgICAgICAgICAgICdkYXRhJzogSlNPTiwgLy8gZmlsZTogZW4uanNvblxuICAgICAgICAgICAgICAncmVnaW9uJzoge1xuICAgICAgICAgICAgICAgICd1cyc6IEpTT04sIC8vIGZpbGU6IGVuLXVzLmpzb25cbiAgICAgICAgICAgICAgICAndWsnOiBKU09OXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgemg6IHtcbiAgICAgICAgICAgICAgJ2RhdGEnOiBKU09OLCAvLyBmaWxlOiB6aC5qc29uXG4gICAgICAgICAgICAgICdyZWdpb24nOiB7XG4gICAgICAgICAgICAgICAgJ2NuJzogSlNPTixcbiAgICAgICAgICAgICAgICAndHcnOiBKU09OXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICovXG4gICAgICAgIHRoaXMubG9jYWxlcyA9IHt9O1xuICAgICAgICBpZiAoXy5pc05pbChjYWxsYmFjaykpIHtcbiAgICAgICAgICAgIHRoaXMubG9hZF9hbGxfbG9jYWxlc1N5bmModGhpcy5jb25maWdbJ2xvY2FsZV9wYXRoJ10pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2FkX2FsbF9sb2NhbGVzKHRoaXMuY29uZmlnWydsb2NhbGVfcGF0aCddLCBjYWxsYmFjayk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpbml0IGdsb2JhbHNcbiAgICAgICAgZ2xvYmFsW3RoaXMuY29uZmlnWyd0cmFuc2xhdGUnXV0gPSB0aGlzLl90LmJpbmQodGhpcyk7XG4gICAgICAgIGdsb2JhbFt0aGlzLmNvbmZpZ1snZXZhbCddXSA9IHRoaXMuX2UuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBGcmFnbGF0ZS5FVkFMID0gRnJhZ2xhdGVFdmFsO1xuXG4gICAgRnJhZ2xhdGUuREVGQVVMVF9DT05GSUcgPSB7XG4gICAgICAgICd0cmFuc2xhdGUnOiAnX3QnLFxuICAgICAgICAnZXZhbCc6ICdfZScsXG4gICAgICAgICdsb2NhbGVfcGF0aCc6IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAnbG9jYWxlJyksXG4gICAgICAgICdsb2NhbGVfZXh0ZW5zaW9uJzogJ2pzb24nLFxuICAgICAgICAnZGVmYXVsdF9sb2NhbGUnOiAnZW4nLFxuICAgICAgICAnY29va2llbmFtZSc6ICdsb2NhbGUnLFxuICAgIH07XG5cbiAgICAvLyBFeGFtcGxlOlxuICAgIC8vICAgR0VUX0FDQ0VQVEVEX0xBTkdVQUdFU19GUk9NX0hFQURFUignZW4tVVMsZW47cT0wLjgsemgtQ047cT0wLjYsemg7cT0wLjQsemgtVFc7cT0wLjInKVxuICAgIC8vICAgPT0+IFsgWyAnZW4tVVMnLCAxIF0sIFsgJ2VuJywgMC44IF0sIFsgJ3poLUNOJywgMC42IF0sIFsgJ3poJywgMC40IF0sIFsgJ3poLVRXJywgMC4yIF0gXVxuICAgIEZyYWdsYXRlLkdFVF9BQ0NFUFRFRF9MQU5HVUFHRVNfRlJPTV9IRUFERVIgPSBmdW5jdGlvbihoZWFkZXIpIHtcbiAgICAgICAgdmFyIGxhbmd1YWdlcyA9IGhlYWRlci5zcGxpdCgnLCcpO1xuICAgICAgICByZXR1cm4gbGFuZ3VhZ2VzLm1hcChmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICB2YXIgcHJlZmVyZW5jZSA9IGl0ZW0udHJpbSgpLnNwbGl0KCc7cT0nKTtcbiAgICAgICAgICAgIGlmIChwcmVmZXJlbmNlLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgICAgICBwcmVmZXJlbmNlLnB1c2goMS4wKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIHF1YWxpdHkgPSBwYXJzZUZsb2F0KHByZWZlcmVuY2VbMV0pO1xuICAgICAgICAgICAgICAgIHByZWZlcmVuY2VbMV0gPSBxdWFsaXR5ID8gcXVhbGl0eSA6IDAuMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmVmZXJlbmNlO1xuICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24ocHJlZmVyZW5jZSkge1xuICAgICAgICAgICAgcmV0dXJuIHByZWZlcmVuY2VbMV0gPiAwO1xuICAgICAgICB9KS5zb3J0KGZ1bmN0aW9uKHByZWZlcmVuY2UxLCBwcmVmZXJlbmNlMikge1xuICAgICAgICAgICAgLy8gYWNjZW5kaW5nXG4gICAgICAgICAgICByZXR1cm4gcHJlZmVyZW5jZTJbMV0gLSBwcmVmZXJlbmNlMVsxXTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIC8vIGFzX21pZGRsZXdhcmUgd2lsbCBwcm92aWRlIGVhY2ggcmVxdWVzdCB3aXRoIHByb3BlcnR5OiAnbG9jYWxlJyBhcyBiZXN0IG1hdGNoZWQgbG9jYWxlXG4gICAgRnJhZ2xhdGUucHJvdG90eXBlLmFzX21pZGRsZXdhcmUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICAgICAgICBpZiAoIXJlcS5sb2NhbGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmd1ZXNzX2xhbmd1YWdlKHJlcSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmV4cHJlc3NfcmVxdWVzdCA9IHJlcTtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuICAgIH07XG5cbiAgICBGcmFnbGF0ZS5wcm90b3R5cGUucHJvY2Vzc19sb2NhbGVfY29udGVudCA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBmaWxlY29udGVudCkge1xuICAgICAgICB2YXIgbGFuZ19yZWdpb24gPSBfX2dldF9sYW5nX3JlZ2lvbihmaWxlbmFtZS5yZXBsYWNlKC9cXC5qc29uJC9nLCAnJykpO1xuICAgICAgICB2YXIgbGFuZyA9IGxhbmdfcmVnaW9uWzBdO1xuICAgICAgICB2YXIgcmVnaW9uID0gbGFuZ19yZWdpb25bMV07XG4gICAgICAgIHZhciBjb250ZW50ID0gSlNPTi5wYXJzZShmaWxlY29udGVudCk7XG4gICAgICAgIGlmIChfLmlzTmlsKHJlZ2lvbikpIHtcbiAgICAgICAgICAgIGlmIChfLmlzTmlsKHRoaXMubG9jYWxlc1tsYW5nXSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZXNbbGFuZ10gPSB7XG4gICAgICAgICAgICAgICAgICAgICdkYXRhJzogY29udGVudCxcbiAgICAgICAgICAgICAgICAgICAgJ3JlZ2lvbic6IHt9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2NhbGVzW2xhbmddWydkYXRhJ10gPSBjb250ZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKF8uaXNOaWwodGhpcy5sb2NhbGVzW2xhbmddKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlc1tsYW5nXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgJ2RhdGEnOiAnJyxcbiAgICAgICAgICAgICAgICAgICAgJ3JlZ2lvbic6IHt9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZXNbbGFuZ11bJ3JlZ2lvbiddW3JlZ2lvbl0gPSBjb250ZW50O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZXNbbGFuZ11bJ3JlZ2lvbiddW3JlZ2lvbl0gPSBjb250ZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIEZyYWdsYXRlLnByb3RvdHlwZS5sb2FkX2FsbF9sb2NhbGVzID0gZnVuY3Rpb24obG9jYWxlX3BhdGgsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBsb2FkX2FsbF9sb2NhbGVzX2FzeW5jID0gX19hc3luY19fKGZ1bmN0aW9uKGxvY2FsZV9wYXRoLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIGZpbGVzID0gX19hd2FpdF9fKGZzLnJlYWRkaXJBc3luYyhsb2NhbGVfcGF0aCkpO1xuICAgICAgICAgICAgdmFyIGZpbGVfY29udGVudF9wYWlycyA9IF9fYXdhaXRfXyhmaWxlcy5tYXAoZnVuY3Rpb24oZmlsZW5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZnMucmVhZEZpbGVBc3luYyhwYXRoLmpvaW4obG9jYWxlX3BhdGgsIGZpbGVuYW1lKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtmaWxlbmFtZSwgY29udGVudF07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgZmlsZV9jb250ZW50X3BhaXJzLm1hcChmdW5jdGlvbihmaWxlX2NvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICB2YXIgZmlsZW5hbWUgPSBmaWxlX2NvbnRlbnRbMF07XG4gICAgICAgICAgICAgICAgdmFyIGZpbGVjb250ZW50ID0gZmlsZV9jb250ZW50WzFdO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc19sb2NhbGVfY29udGVudChmaWxlbmFtZSwgZmlsZWNvbnRlbnQpO1xuICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgICBsb2FkX2FsbF9sb2NhbGVzX2FzeW5jKGxvY2FsZV9wYXRoKS50aGVuKGNhbGxiYWNrKS5jYXRjaChjYWxsYmFjayk7XG4gICAgfTtcblxuICAgIEZyYWdsYXRlLnByb3RvdHlwZS5sb2FkX2FsbF9sb2NhbGVzU3luYyA9IGZ1bmN0aW9uKGxvY2FsZV9wYXRoKSB7XG4gICAgICAgIHZhciBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGxvY2FsZV9wYXRoKTtcbiAgICAgICAgZmlsZXMubWFwKGZ1bmN0aW9uKGZpbGVuYW1lKSB7XG4gICAgICAgICAgICB2YXIgY29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4obG9jYWxlX3BhdGgsIGZpbGVuYW1lKSk7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NfbG9jYWxlX2NvbnRlbnQoZmlsZW5hbWUsIGNvbnRlbnQpO1xuICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgIH07XG5cbiAgICBGcmFnbGF0ZS5wcm90b3R5cGUuZ3Vlc3NfbGFuZ3VhZ2UgPSBmdW5jdGlvbihyZXEpIHtcbiAgICAgICAgaWYgKCEodHlwZW9mIHJlcSA9PT0gJ29iamVjdCcpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBjaGVjayBjb29raWVcbiAgICAgICAgdmFyIGNvb2tpZW5hbWUgPSB0aGlzLmNvbmZpZ1snY29va2llbmFtZSddO1xuICAgICAgICBpZiAoIV8uaXNOaWwoY29va2llbmFtZSkgJiYgIV8uaXNOaWwocmVxLmNvb2tpZXMpICYmICFfLmlzTmlsKHJlcS5jb29raWVzW2Nvb2tpZW5hbWVdKSkge1xuICAgICAgICAgICAgdmFyIGNvb2tpZV9sb2NhbGUgPSByZXEuY29va2llc1tjb29raWVuYW1lXTtcbiAgICAgICAgICAgIHZhciBsYW5nX3JlZ2lvbiA9IF9fZ2V0X2xhbmdfcmVnaW9uKGNvb2tpZV9sb2NhbGUpO1xuICAgICAgICAgICAgaWYgKF9faXNfZXhpc3RfbG9jYWxlKHRoaXMubG9jYWxlcywgbGFuZ19yZWdpb25bMF0sIGxhbmdfcmVnaW9uWzFdKSkge1xuICAgICAgICAgICAgICAgIHJlcS5sb2NhbGUgPSBfX2NvbnN0cnVjdF9sYW5nX3JlZ2lvbihsYW5nX3JlZ2lvblswXSwgbGFuZ19yZWdpb25bMV0pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGd1ZXNzIHJlcXVlc3QgaGVhZGVyOiBhY2NlcHQtbGFuZ3VhZ2VcbiAgICAgICAgdmFyIGFjY19sYW5ncyA9IHJlcS5oZWFkZXJzWydhY2NlcHQtbGFuZ3VhZ2UnXTtcbiAgICAgICAgaWYgKGFjY19sYW5ncykge1xuICAgICAgICAgICAgdmFyIHByZWZfbGFuZ3MgPSBGcmFnbGF0ZS5HRVRfQUNDRVBURURfTEFOR1VBR0VTX0ZST01fSEVBREVSKGFjY19sYW5ncyk7XG4gICAgICAgICAgICB2YXIgYmVzdEd1ZXNzID0gbnVsbCxcbiAgICAgICAgICAgICAgICBmYWxsYmFja0d1ZXNzID0gbnVsbDtcbiAgICAgICAgICAgIHZhciBkZWZhdWx0TG9jYWxlID0gX19nZXRfbGFuZ19yZWdpb24odGhpcy5jb25maWdbJ2RlZmF1bHRfbG9jYWxlJ10pO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmVmX2xhbmdzLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmdfcmVnaW9uID0gX19nZXRfbGFuZ19yZWdpb24ocHJlZl9sYW5nc1tpXVswXSk7XG4gICAgICAgICAgICAgICAgdmFyIGxhbmcgPSBsYW5nX3JlZ2lvblswXTtcbiAgICAgICAgICAgICAgICB2YXIgcmVnaW9uID0gbGFuZ19yZWdpb25bMV07XG4gICAgICAgICAgICAgICAgdmFyIGxvY2FsZXNfbGFuZyA9IHRoaXMubG9jYWxlc1tsYW5nXTtcbiAgICAgICAgICAgICAgICB2YXIgbG9jYWxlc19yZWdpb24gPSB0aGlzLmxvY2FsZXNbbGFuZ11bJ3JlZ2lvbiddW3JlZ2lvbl07XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNOaWwocmVnaW9uKSAmJiAhXy5pc05pbChsb2NhbGVzX2xhbmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGJlc3RHdWVzcyA9IFtsYW5nLCBudWxsXTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghXy5pc05pbChyZWdpb24pICYmICFfLmlzTmlsKGxvY2FsZXNfbGFuZykgJiYgIV8uaXNOaWwobG9jYWxlc19yZWdpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGJlc3RHdWVzcyA9IFtsYW5nLCByZWdpb25dO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFfLmlzTmlsKHJlZ2lvbikgJiYgIV8uaXNOaWwobG9jYWxlc19sYW5nKSAmJiBfLmlzTmlsKGxvY2FsZXNfcmVnaW9uKSkge1xuICAgICAgICAgICAgICAgICAgICBmYWxsYmFja0d1ZXNzID0gW2xhbmcsIG51bGxdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBmaW5hbEd1ZXNzID0gYmVzdEd1ZXNzIHx8IGZhbGxiYWNrR3Vlc3MgfHwgZGVmYXVsdExvY2FsZTtcbiAgICAgICAgICAgIHJlcS5sb2NhbGUgPSBfX2NvbnN0cnVjdF9sYW5nX3JlZ2lvbihmaW5hbEd1ZXNzWzBdLCBmaW5hbEd1ZXNzWzFdKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBGcmFnbGF0ZS5wcm90b3R5cGUuX3QgPSBmdW5jdGlvbihrZXksIGxvY2FsZV9zdHIsIGNvbnRleHQpIHtcbiAgICAgICAgaWYgKF8uaXNOaWwobG9jYWxlX3N0cikpIHtcbiAgICAgICAgICAgIGxvY2FsZV9zdHIgPSAoICghXy5pc05pbCh0aGlzLmV4cHJlc3NfcmVxdWVzdCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICA/ICh0aGlzLmV4cHJlc3NfcmVxdWVzdC5sb2NhbGUpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICA6ICh0aGlzLmNvbmZpZ1snZGVmYXVsdF9sb2NhbGUnXSkgKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgbGFuZ19yZWdpb24gPSBfX2dldF9sYW5nX3JlZ2lvbihsb2NhbGVfc3RyKTtcbiAgICAgICAgdmFyIGxhbmcgPSBsYW5nX3JlZ2lvblswXTtcbiAgICAgICAgdmFyIHJlZ2lvbiA9IGxhbmdfcmVnaW9uWzFdO1xuICAgICAgICBpZiAoIV9faXNfZXhpc3RfbG9jYWxlKHRoaXMubG9jYWxlcywgbGFuZywgcmVnaW9uKSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIkxvY2FsZSAnXCIgKyBsb2NhbGVfc3RyICsgXCInIGlzIG5vdCBjb25maWd1cmVkIVwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJMb2NhbGUgYXZhaWxhYmxlOiBcIiArIEpTT04uc3RyaW5naWZ5KHRoaXMubG9jYWxlcykpO1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZShrZXksIGxhbmcsIHJlZ2lvbiwgY29udGV4dCk7XG4gICAgfTtcblxuICAgIEZyYWdsYXRlLnByb3RvdHlwZS5fZSA9IGZ1bmN0aW9uKHN0ciwgbG9jYWxlX3N0ciwgY29udGV4dCkge1xuICAgICAgICBpZiAoXy5pc05pbChsb2NhbGVfc3RyKSkge1xuICAgICAgICAgICAgbG9jYWxlX3N0ciA9ICggKCFfLmlzTmlsKHRoaXMuZXhwcmVzc19yZXF1ZXN0KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKHRoaXMuZXhwcmVzc19yZXF1ZXN0LmxvY2FsZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKHRoaXMuY29uZmlnWydkZWZhdWx0X2xvY2FsZSddKSApO1xuICAgICAgICB9XG4gICAgICAgIHZhciBsYW5nX3JlZ2lvbiA9IF9fZ2V0X2xhbmdfcmVnaW9uKGxvY2FsZV9zdHIpO1xuICAgICAgICB2YXIgbGFuZyA9IGxhbmdfcmVnaW9uWzBdO1xuICAgICAgICB2YXIgcmVnaW9uID0gbGFuZ19yZWdpb25bMV07XG4gICAgICAgIGlmICghX19pc19leGlzdF9sb2NhbGUodGhpcy5sb2NhbGVzLCBsYW5nLCByZWdpb24pKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiTG9jYWxlICdcIiArIGxvY2FsZV9zdHIgKyBcIicgaXMgbm90IGNvbmZpZ3VyZWQhXCIpO1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgRnJhZ2xhdGUuRVZBTCh0aGlzKS5ldmFsKHN0ciwgbGFuZywgcmVnaW9uLCBjb250ZXh0KTtcbiAgICB9O1xuXG4gICAgRnJhZ2xhdGUucHJvdG90eXBlLnRyYW5zbGF0ZSA9IGZ1bmN0aW9uKGtleSwgbGFuZywgcmVnaW9uLCBjb250ZXh0KSB7XG4gICAgICAgIHZhciBmZSA9IG5ldyBGcmFnbGF0ZS5FVkFMKHRoaXMpO1xuICAgICAgICB2YXIgbG9jYWxldW5pdCA9ICggKF8uaXNOdWxsKHJlZ2lvbikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICA/ICh0aGlzLmxvY2FsZXNbbGFuZ11bJ2RhdGEnXVtrZXldKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAodGhpcy5sb2NhbGVzW2xhbmddWydyZWdpb24nXVtyZWdpb25dW2tleV0pKTtcbiAgICAgICAgaWYgKHR5cGVvZiBsb2NhbGV1bml0ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIGZlLmV2YWwobG9jYWxldW5pdCwgbGFuZywgcmVnaW9uLCBjb250ZXh0KTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9jYWxldW5pdCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2xvY2FsZTogJyArIGxvY2FsZS50b1N0cmluZygpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICsgJywgbm8gdHJhbnNsYXRpb24gdG8ga2V5OiBcIidcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKyBrZXkudG9TdHJpbmcoKSArICdcIicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignbG9jYWxlOiAnICsgbG9jYWxlLnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnLCB0cmFuc2xhdGlvbiB0byBcXCcnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICsgKHR5cGVvZiBsb2NhbGV1bml0KS50b1N0cmluZygpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICsgJ1xcJyBpcyBub3Qgc3VwcG9ydGVkIScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH07XG5cbiAgICByZXR1cm4gRnJhZ2xhdGU7XG59KSgpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IEZyYWdsYXRlQ2xhc3M7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
